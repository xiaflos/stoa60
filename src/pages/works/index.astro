---
// layout
import Layout from "../../layouts/Layout.astro";

// components
import Heading from "../../components/elements/Heading.astro";
import Container from "../../components/elements/Container.astro";
import { Image } from "astro:assets";

// Import all posters from season folders
const allImages = import.meta.glob<{ default: ImageMetadata }>(
    "../../assets/images/posters/**/*.{jpg,jpeg,png}",
    { eager: true }
);

// Group by season and sort files naturally by filename
const seasonMap: Record<string, { filename: string; image: ImageMetadata }[]> = {};

for (const [path, module] of Object.entries(allImages)) {
    const parts = path.split("/");
    const season = parts[parts.length - 2];
    const filename = parts[parts.length - 1];
    if (!seasonMap[season]) seasonMap[season] = [];
    seasonMap[season].push({ filename, image: module.default });
}

const seasons = Object.keys(seasonMap)
    .sort((a, b) => b.localeCompare(a)) // newest first
    .map(year => ({
        year,
        posters: seasonMap[year]
            .sort((a, b) => a.filename.localeCompare(b.filename, undefined, { numeric: true, sensitivity: "base" }))
            .map(item => item.image)
    }));
---

<Layout title="Posters">
    <Container variant={'xl'} class="flex flex-col !gap-2 items-start">
        <nav class="flex flex-wrap gap-4 md:gap-8 justify-start">
            <a href="/" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">Home</a>
            <a href="/works" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">Posters</a>
            <a href="/about" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">About</a>
        </nav>
        <Heading tagName="h1" tagSize="h1" class="text-left">Posters</Heading>

        {seasons.map((season, seasonIndex) => {
            const startIndex = seasons.slice(0, seasonIndex).reduce((acc, s) => acc + s.posters.length, 0);
            return (
                <section class="w-full mt-8">
                    <h2 class="font-grunge text-4xl text-base-900 mb-4">{season.year}</h2>
                    <div class="grid lg:grid-cols-4 md:grid-cols-3 grid-cols-2 gap-8 w-full">
                        {season.posters.map((poster, index) => (
                            <div class="w-full cursor-pointer poster-thumb" data-index={startIndex + index}>
                                <Image
                                    src={poster}
                                    alt={`Poster from ${season.year}`}
                                    class="w-full h-auto object-contain hover:opacity-80 transition-opacity"
                                    loading="lazy"
                                />
                            </div>
                        ))}
                    </div>
                </section>
            );
        })}
    </Container>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-8">
        <button id="close-lightbox" class="absolute top-4 right-4 text-white text-4xl font-grunge hover:opacity-70">&times;</button>
        <img id="lightbox-img" src="" alt="Poster preview" class="max-h-[90vh] max-w-[90vw] object-contain" />
    </div>

    <script>
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const closeBtn = document.getElementById('close-lightbox');
        const thumbs = document.querySelectorAll('.poster-thumb');

        const posterSrcs = Array.from(thumbs).map(thumb => thumb.querySelector('img').src);

        function openLightbox(index) {
            lightboxImg.src = posterSrcs[index];
            lightbox.classList.remove('hidden');
            lightbox.classList.add('flex');
            history.pushState({ lightbox: true }, '');
        }

        function closeLightbox() {
            lightbox.classList.add('hidden');
            lightbox.classList.remove('flex');
        }

        thumbs.forEach((thumb) => {
            thumb.addEventListener('click', () => {
                openLightbox(parseInt(thumb.dataset.index));
            });
        });

        closeBtn.addEventListener('click', () => {
            closeLightbox();
            history.back();
        });

        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
                history.back();
            }
        });

        window.addEventListener('popstate', (e) => {
            if (!e.state?.lightbox) closeLightbox();
        });
    </script>
</Layout>
