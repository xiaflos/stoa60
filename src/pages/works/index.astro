---
// layout
import Layout from "../../layouts/Layout.astro";

// components
import Heading from "../../components/elements/Heading.astro";
import Container from "../../components/elements/Container.astro";
import { Image } from "astro:assets";

// Import all posters from season folders
const allImages = import.meta.glob<{ default: ImageMetadata }>(
    "../../assets/images/posters/**/*.{jpg,jpeg,png}",
    { eager: true }
);

// Group by season and sort files naturally by filename
const seasonMap: Record<string, { filename: string; image: ImageMetadata }[]> = {};

for (const [path, module] of Object.entries(allImages)) {
    const parts = path.split("/");
    const season = parts[parts.length - 2];
    const filename = parts[parts.length - 1];
    if (!seasonMap[season]) seasonMap[season] = [];
    seasonMap[season].push({ filename, image: module.default });
}

const seasons = Object.keys(seasonMap)
    .sort((a, b) => b.localeCompare(a)) // newest first
    .map(year => ({
        year,
        posters: seasonMap[year]
            .sort((a, b) => a.filename.localeCompare(b.filename, undefined, { numeric: true, sensitivity: "base" }))
            .map(item => item.image)
    }));
---

<Layout title="Posters">
    <Container variant={'xl'} class="flex flex-col !gap-2 items-start">
        <nav class="flex flex-wrap gap-4 md:gap-8 justify-start">
            <a href="/" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">Home</a>
            <a href="/works" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">Posters</a>
            <a href="/about" class="text-base-900 font-grunge text-3xl underline underline-offset-4 decoration-2 hover:text-base-700">About</a>
        </nav>
        <Heading tagName="h1" tagSize="h1" class="text-left">Posters</Heading>

        <!-- Season accordion -->
        {seasons.map((season, seasonIndex) => (
            <details class="w-full mt-4 season-accordion" open={seasonIndex === 0}>
                <summary class="font-grunge text-4xl md:text-5xl text-base-900 cursor-pointer list-none flex items-center gap-4 py-3 border-b border-base-900/20 hover:text-base-700 select-none">
                    <svg
                        class="season-chevron w-6 h-6 shrink-0 transition-transform duration-300 fill-current"
                        viewBox="0 0 8 8"
                        xmlns="http://www.w3.org/2000/svg"
                    >
                        <path d="M1.5 1L0 2.5l4 4 4-4L6.5 1 4 3.5 1.5 1z"/>
                    </svg>
                    <span>{season.year}</span>
                    <span class="text-base-900/40 font-mono text-sm ml-auto">{season.posters.length}</span>
                </summary>
                <div class="season-content grid grid-rows-[0fr] transition-[grid-template-rows] duration-300 ease-in-out">
                    <div class="overflow-hidden">
                        <div class="grid lg:grid-cols-4 md:grid-cols-3 grid-cols-2 gap-8 w-full pt-6 pb-4">
                            {season.posters.map((poster) => (
                                <div class="w-full cursor-pointer poster-thumb">
                                    <Image
                                        src={poster}
                                        alt={`Poster from ${season.year}`}
                                        class="w-full h-auto object-contain hover:opacity-80 transition-opacity"
                                        loading="lazy"
                                    />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </details>
        ))}
    </Container>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center">
        <button id="close-lightbox" class="absolute top-4 right-4 text-white text-4xl font-grunge hover:opacity-70 z-10">&times;</button>
        <button id="prev-lightbox" class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-5xl font-grunge hover:opacity-70 z-10 select-none">&#8249;</button>
        <button id="next-lightbox" class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-5xl font-grunge hover:opacity-70 z-10 select-none">&#8250;</button>
        <img id="lightbox-img" src="" alt="Poster preview" class="max-h-[90vh] max-w-[85vw] object-contain" />
    </div>

    <style>
        /* Hide native marker */
        details summary::-webkit-details-marker { display: none; }

        /* Rotate chevron when open */
        details[open] .season-chevron { transform: rotate(180deg); }

        /* Animate grid rows open */
        details[open] .season-content { grid-template-rows: 1fr; }
    </style>

    <script>
        // --- Dynamic lightbox indexing ---
        const lightbox = document.getElementById('lightbox')!;
        const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
        const closeBtn = document.getElementById('close-lightbox')!;
        const prevBtn = document.getElementById('prev-lightbox')!;
        const nextBtn = document.getElementById('next-lightbox')!;

        let visiblePosters: HTMLElement[] = [];
        let currentIndex = 0;

        function rebuildIndex() {
            visiblePosters = Array.from(
                document.querySelectorAll<HTMLElement>('details[open] .poster-thumb')
            );
        }

        function openLightbox(index: number) {
            if (index < 0 || index >= visiblePosters.length) return;
            currentIndex = index;
            const img = visiblePosters[index].querySelector('img');
            if (!img) return;
            lightboxImg.src = img.src;
            lightbox.classList.remove('hidden');
            lightbox.classList.add('flex');
            updateArrows();
            history.pushState({ lightbox: true }, '');
        }

        function closeLightbox() {
            lightbox.classList.add('hidden');
            lightbox.classList.remove('flex');
        }

        function updateArrows() {
            prevBtn.style.visibility = currentIndex > 0 ? 'visible' : 'hidden';
            nextBtn.style.visibility = currentIndex < visiblePosters.length - 1 ? 'visible' : 'hidden';
        }

        // Rebuild index whenever any season is toggled
        document.querySelectorAll('.season-accordion').forEach(details => {
            details.addEventListener('toggle', () => rebuildIndex());
        });

        // Delegate click on poster thumbs
        document.addEventListener('click', (e) => {
            const thumb = (e.target as HTMLElement).closest('.poster-thumb') as HTMLElement | null;
            if (!thumb) return;
            rebuildIndex();
            const idx = visiblePosters.indexOf(thumb);
            if (idx !== -1) openLightbox(idx);
        });

        // Prev / Next
        prevBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentIndex > 0) openLightbox(currentIndex - 1);
        });
        nextBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (currentIndex < visiblePosters.length - 1) openLightbox(currentIndex + 1);
        });

        // Close
        closeBtn.addEventListener('click', () => { closeLightbox(); history.back(); });
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) { closeLightbox(); history.back(); }
        });

        // Keyboard: arrows + escape
        window.addEventListener('keydown', (e) => {
            if (lightbox.classList.contains('hidden')) return;
            if (e.key === 'Escape') { closeLightbox(); history.back(); }
            if (e.key === 'ArrowLeft' && currentIndex > 0) openLightbox(currentIndex - 1);
            if (e.key === 'ArrowRight' && currentIndex < visiblePosters.length - 1) openLightbox(currentIndex + 1);
        });

        // Browser back button
        window.addEventListener('popstate', (e) => {
            if (!e.state?.lightbox) closeLightbox();
        });

        // Initial index build
        rebuildIndex();
    </script>
</Layout>
